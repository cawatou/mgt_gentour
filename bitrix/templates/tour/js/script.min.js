$(document).ready(function(){
    var city_id = $('.cityAll .letterlist a.active').data('citytv');
    var city_idSec = $('.cityAll .letterlist a.active').data('city');
    if($("#fullPage").length)
      load_tours(city_id, city_idSec);
  else {
      preloadOff();
  }
  var selectCity = $('select.departure');
  var placeholder = selectCity.find('option:first');
  var option, id;
  $.ajax({
    type: 'post',
    url: '/ajax/dev.php',
    data: {
        "get_city": 1
    },
    success: function (json) {
        $('select').styler('destroy')
        var xK='';
        JSON.parse(json, function (key, value) {

            if (key == 'id') id = value;
            if (key == 'name') {
               if(userCity==value) { xK=' selected '; } else xK='';
               option = '<option value="' + id + '">' + value + '</option>';
               selectCity.append(option);

           }
       });
        initDropdown()


    }
})
})

$('.departure').on('change', function () {
    var departure_id = $(this).val();
    var selectCountry = $('select.country');
    var placeholder = selectCountry.find('option:first');
    var option, id;

    selectCountry.html('');
    selectCountry.append(placeholder);

    $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: {
            "departure_id": departure_id
        },
        success: function (json) {
            JSON.parse(json, function (key, value) {
                if (key == 'id') id = value;
                if (key == 'name') {
                    option = '<option value="' + id + '">' + value + '</option>';
                    selectCountry.styler('destroy')
                    selectCountry.append(option);
                    initDropdown()
                }
            });
        }
    })
});

$('.country').on('change', function () {
    var country_id = $(this).val();
    var selectRegions = $('select.regions');
    var placeholder = selectRegions.find('option:first');
    var option, id;

    selectRegions.html('');
    selectRegions.append(placeholder);

    $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: {
            "country_id": country_id
        },
        success: function (json) {
            JSON.parse(json, function (key, value) {
                if (key == 'id') id = value;
                if (key == 'name') {
                    option = '<option value="' + id + '">' + value + '</option>';
                    selectRegions.append(option);
                    selectRegions.trigger('refresh')
                }
            });
        }
    })
});

$('#gen_tours input[type=submit]').on('click', function (e) {
    $('input.requestid').val(0);
    $('input.status').val(0);
})
var checkGenerationProccess = false
$('#gen_tours').on('submit', function (e) {
    e.preventDefault();

    if(checkGenerationProccess){
        return false
    }
    else {
        checkGenerationProccess = true
    }

    $('#gen_tours input[type=submit]').attr('disable');
    var data = $(this).serializeArray();

    var requestid = $('input.requestid').val();
    var status = $('input.status').val();
    if (requestid == '0') {
        data.push({name: 'get_requestid', value: 1});
        $.ajax({
            type: 'post',
            url: '/ajax/dev.php',
            data: data,
            success: function (res) {
                /*console.log(res);*/
                $('pre.result').html(res);
                $('input.requestid').val(res);
                $('#gen_tours').submit();
            }
        })
    } else if (status != '100') {
        data.push({name: 'get_status', value: 1});
        check_status(data);
        status = $('input.status').val();
        $('pre.result').html(status);
        $('pre.result').append(' wait ..');

        var intervalID = setInterval(function () {
            if (status != '100') {
                check_status(data);
                status = $('input.status').val();
            } else {
                /*console.log('end');*/
                $('#gen_tours').submit();
                clearInterval(intervalID);
            }
        }, 10000);
    } else if (status == '100') {
        //Запрос результата
        var checkGenerationProccess = false
        var data = $(this).serializeArray();
        if($('#region_name').val() === '') var category = $(".departure option:selected").html() + " - " + $(".country option:selected").html() + "(" + $(".regions option:selected").html() + ")";
        var category = $(".departure option:selected").html() + " - " + $(".country option:selected").html() + "(" + $('#region_name').val() + ")";
        data.push({name: 'get_result', value: 1});
        data.push({name: 'cat_name', value: category});

        $.ajax({
            type: 'post',
            data: data,
            url: '/ajax/dev.php',
            success: function (res) {
                if (res != 'empty') {
                    /*console.log(res);*/
                    $('pre.result').html(res);
                    var data = $('#gen_tours').serializeArray();
                    data.push({name: 'cat_name', value: category});
                    new_items(data);
                } else {
                    $('pre.result').html('Туры не найдены');
                }
            }
        })

    }

});

// Селект отправления на главной
$('.city_departure').on('change', function () {
    var departure_id = $(this).val();
    var departure_idSec = $('.cityAll .letterlist a.active').data('city');
    load_tours(departure_id, departure_idSec);
});

// Заполнение модального окна (Оплатить онлайн)
$('.payonline').on('click', function(){
    var tourvisor_id = $(this).parent().attr('data-tourvid');
    var bx_id = $(this).parent().attr('data-bxid');
    var bxt_id = $(this).closest('.tabwrap').data('id');
    $.ajax({
        type: 'post',
        url: '/ajax/modal_tour.php',
        data: {
            'pay_online': 1,
            'tourid': tourvisor_id,
            'bxid': bx_id,
            'bxtid': bxt_id
        },
        beforeSend: function(){
         $('#buyme .modal-body').html('<div style="text-align:center"> <img src="/bitrix/templates/tour/images/89.gif"> </div>');
     },
     success: function(res){
        $('#buyme .modal-body').html(res);
        $('#buyme button.disabled').addClass("byeme");
        $('#buyme button.disabled').removeClass("disabled");
    }
})
})

// Заполнение модального окна (Оплатить в офисе)
$('.payoffice').on('click', function(){
    var tourvisor_id = $(this).parent().attr('data-tourvid');
    var bx_id = $(this).parent().data('bxid');
    var bxt_id = $(this).closest('.tabwrap').data('id');
    if(tourvisor_id){$('input[name=tourid]').val(tourvisor_id)}else{$('input[name=tourid]').val(bx_id)}
       $.ajax({
        type: 'post',
        url: '/ajax/modal_tour.php',
        data: {
            'pay_office': 1,
            'tourid': tourvisor_id,
            'bxid': bx_id,
            'bxtid': bxt_id
        },
        beforeSend: function(){
         $('#order .modal-body .form-order-info').html('<div style="text-align:center"> <img src="/bitrix/templates/tour/images/89.gif"> </div>');
     },
     success: function(res){
        $('#order .modal-body .form-order-info').html(res);
    }
})
})

$(document).on('click','#add_hotel_group button',function(e){
    var group = $("#add_hotel_group select").val();
    if(group != 0) {
        $('#hgroup').val(group);
        var data = $("#hotel_data").serialize();

        $.ajax({
            type: 'post',
            url: '/ajax/hotel_group.php',
            data: data,
            success: function(res){
                if(res == 'add') alert("Добавлено");
                if(res == 'update') alert("Обновлено");
            }
        })
    }
})

// Регистрация пользователя региональным менеджером
$('#add_user_regional').on('submit', function(e){
    e.preventDefault();
    var data = $(this).serialize();
    $.ajax({
        type: 'post',
        url: '/ajax/adduser_regional.php',
        data: data,
        beforeSend: function(){
            $('#buyme .modal-body').html('<div style="text-align:center"> <img src="/bitrix/templates/tour/images/89.gif"> </div>');
        },
        success: function(res){            
            if(res == "done") {
                alert('Новый пользователь добавлен');
                $('#add_user_regional .fields').val('');
            }else{
                alert(res);
            }
        }
    })
})

/*=========================================== FUNCTIONS ====================================================*/

function check_status(data) {
    $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: data,
        success: function (res) {
            $('input.status').val(res);
            $('pre.result').html(res);
            $('pre.result').append('% wait ..');
        }
    })
}

function new_items(data) {
    var departure_name = $(".departure option:selected").html();
    data.push({name: 'new_items', value: 1});
    data.push({name: 'departure_name', value: departure_name});
    $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: data,
        success: function (res) {
            $('pre.result').html('Туры добавлены.');
        }
    })
}









function load_tours(city_id, city_idSecond, reload){
    /*Загрузка первых 4 ех туров в витрину*/

    

    $("body,html").animate({scrollTop: 0}, 400);
    $('#scroller').fadeOut()
    getCountry()


    var tabletOrientedCarousel = false;
    if($(window).width() < 993 && $(window).width() > 620) {
       tabletOrientedCarousel = true;
   }

   if(reload) {


       var firstSecLoaded =  false
       var secondSecLoaded =  false
       var thirdSecLoaded =  false


      

       $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: {
            "load_tour": 1,
            "showcase": 1,
            "city_id":  city_id,
        },
        success: function (res) {

            $('.showcase_tours .gridview').remove();
            $('.showcase_tours .listview').remove();
            $('.showcase_tours .hotindex').append(res);


            firstSecLoaded = true
        }
    })


       $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: {
            "load_tour": 1,
            "remaining_tours": 1,
            "city_id": city_id,
            "tabletOrientedCarousel": tabletOrientedCarousel
        },
        success: function (res) {
           if(res.trim()==''){
             $('.remaining_tours').remove();
         }
         else{
            if($('.remaining_tours').length == 0) {
                $('section.showcase_tours').after('<section class="vertical-scrolling remaining_tours" style=""></section>')
            }
            $('.remaining_tours').html(res);
        }
        secondSecLoaded = true
    }

})



       $.ajax({
          type: 'post',
          url: '/ajax/dev.php',
          data: {
             "load_siblings": 1,
             "city_id":  city_id,
             'tabletOrientedCarousel': tabletOrientedCarousel
         },
         success: function(res){


             if(res == ''){
                $('.sibling_tours').remove();
            }else{

                if($('.sibling_tours').length == 0) {
                    if($('section.remaining_tours').length > 0)
                        $('section.remaining_tours').after('<section class="vertical-scrolling sibling_tours " style="background:url(/upload/iblock/d10/slide2.jpg) no-repeat center center;"></section>')
                    else
                        $('section.showcase_tours').after('<section class="vertical-scrolling sibling_tours " style="background:url(/upload/iblock/d10/slide2.jpg) no-repeat center center;"></section>')
                }
                $('.sibling_tours').html(res);
            }

            thirdSecLoaded = true
        }
    })
   }
   else {

       var firstSecLoaded =  true
       var secondSecLoaded =  true
       var thirdSecLoaded =  true
   }













   var load_tours_interval = setInterval(function(){

    console.log(firstSecLoaded + ', ' + secondSecLoaded + ', ' + thirdSecLoaded )

    if(firstSecLoaded && secondSecLoaded && thirdSecLoaded) {

         renderEmloeyrs(city_idSecond, city_id)

        if($('#fullpage.jobsdone').length == 0) {
            fp();
        }
        else {
            $.fn.fullpage.destroy('all');
            fp();
        }
        if($.fn.fullpage) {
            $.fn.fullpage.moveTo(1)
        }




        $.ajax({
            type: 'post',
            url: '/ajax/dev.php',
            data: {
                "get_news": 1,
                "city_id":  city_idSecond,
            },
            success: function (data) {
                if(data != ''){
                    $('.topNews').html('<i class="closeNews">X</i>'+data)
                    $('.topNews').show()
                }
                else {
                   $('.topNews').hide()
               }

           }
       })

        renderBeautyFuncs()

        clearInterval(load_tours_interval)

        load_tours_interval = false
    }
}, 10)



   /*Загрузка остальных туров в витрину (в виде слайдера)*/



   /* ============= СЮДА ============*/


   function renderBeautyFuncs() {

        var sortedSiblings = $('.sibling_tours .gridviewz>.row>.col-md-3')

         sortedSiblings.sort(function(a, b){

             a = a.getElementsByClassName('tur_price')[0].innerHTML;
             b = b.getElementsByClassName('tur_price')[0].innerHTML;

             var aPr = a.substr(0, a.length - 2).trim()
             var bPr = b.substr(0, b.length - 2).trim()



             return parseInt(aPr) < parseInt(bPr) ? -1 : parseInt(aPr) > parseInt(bPr) ? 1 : 0
         }).each(function () {
             var elem = $(this);
             elem.remove();
             $(elem).appendTo('.sibling_tours .gridviewz>.row');
         });

        

         if($('.remaining_tours .itmbl').length == 0) {
            $('.remaining_tours').remove()
         }
         if($('.sibling_tours .item').length == 0) {
            $('.sibling_tours').remove()
         }
    

       if((tabletOrientedCarousel && $(window).width() < 1000) || $(window).width() < 620) {

        if($(window).width() < 620) {
            var tourForOneSec  = 4
        }
        else {
            var tourForOneSec  = 6
        }

            // $('.hot-carusel2').each(function(){
            //     if($(this).find('.item').length > tourForOneSec) {
            //         $(this).find('.item').eq(0).hide()
            //         $(this).find('.item').eq(1).hide()
            //     }       
            // })
            

            var sec2Count = $('.hot-carusel2').find('.itmbl').length % tourForOneSec ? parseInt($('.hot-carusel2').find('.itmbl').length/tourForOneSec)+1 : parseInt($('.hot-carusel2').find('.itmbl').length/tourForOneSec)

            var thisCountSec2 = $('.remaining_tours .slideTur').length



            if(sec2Count > thisCountSec2) {
                for(var i = sec2Count; thisCountSec2 < i; i--) {
                    $('.remaining_tours .slideTur.s'+thisCountSec2).after('<div class="slideTur s'+i+'"><h1 class="hottur">Горящие туры из моего города</h1><div class="container hotturblock gridviewz"></div></div>')
                }
            }

            var items = $('.hot-carusel2').find('.itmbl')


            
            var y = 0;
            var z = 0;
            for(var i = 1; items.length > i; i+=2){
                if(i%tourForOneSec == 1){
                    y++
                    $('.slideTur.s'+y).find('.gridviewz').after('<div class="container hotturblock gridviewz generatedForDevices"><div class="hot-carusel2 owl-carousel"></div></div>')
                }
                if(i%8 == 1) {
                    z++
                }

                var generatedNow = $('.slideTur.s'+y).find('.generatedForDevices .hot-carusel2')


                $('.slideTur.s'+z).find('.gridviewz').not('.generatedForDevices').find('.hot-carusel2').find('.item:first-child').appendTo(generatedNow)
            }

            $('.slideTur').find('.gridviewz').not('.generatedForDevices').remove()

        }




        $.ajax({
          type: 'post',
          url: '/ajax/rendersocials.php',
          data: {
             "rendersoc": 1,
             "secid":  city_idSecond
         },
         success: function(data){
            $('.socials-block').html(data)
            if($(window).width() <= 1024) {
                $('.socials-block').owlCarousel('destroy')
                $('.socials-block').owlCarousel({
                    responsive: {
                        0: {

                            items: 1
                        },
                        600: {
                            items: 1
                        },
                        768: {
                            items: 2
                        },
                        1000: {
                            items: 4
                        }

                    }
                })
            }

        }
    })

        hblkhvr();
        if($(window).width() < 620){
          $('.tur_night').each(function(){
            $(this).html('<i class="calendar1"></i>' + $(this).text().replace('Количество', 'Кол-во'))
        })
          $('.sibling_tours .hottur').text('Туры из соседних городов')

      }

      function get_name_browser(){
        var ua = navigator.userAgent;    
        if (ua.search(/Chrome/) > 0) return 'Google Chrome';
        if (ua.search(/Firefox/) > 0) return 'Firefox';
        if (ua.search(/Opera/) > 0) return 'Opera';
        if (ua.search(/Safari/) > 0) return 'Safari';
        if (ua.search(/NET/) > 0) return 'IE';

    }

    if(get_name_browser() == 'IE') {

        if($(window).width() > 1024 ) {
            $('.gridviewz').css({
                'width': '1180px'
            })
        }
    }


    if($(window).width() > 1024 && $(window).width() > 1000) {

    }
    hblkhvr();




    var gridview = $('.gridview').owlCarousel({
        margin:20,
        dots:false,
        nav:true,
        responsive:{
            0:{
                items:2,
                center: true,
                loop: true
            },
            600:{
                items:2,
                center: true,
                loop: true
            },
            1000:{
                items:4,
                center: false
            }
        }
    });



    // if(!tabletOrientedCarousel ) {

    //     $('.sibling_tours .hotturblock-mobile .hot-carusel').owlCarousel({
    //         loop:false,
    //         margin:20,
    //         dots:false,
    //         nav:true,
    //         center: false,
    //         responsive:{
    //             0:{
    //                 items:2
    //             },
    //             600:{
    //                 items:2
    //             },
    //             1000:{
    //                 items:4
    //             }
    //         }
    //     });



    // }



    if($(window).width() < 1000 && $(window).width() > 620) {
        gridview.trigger('destroy.owl.carousel');

        $('.gridview').show()



    }





    $(".hotlistview").hover(function(t) {
        $(this).find(".hotlistover").addClass('activated')
    }, function(){
        $(this).find(".hotlistover").removeClass('activated')
    })

    $('.hotlistover i').each(function(){
        if($(this).text().length == 8) {
            $(this).text($(this).text().replace(' ', ''))
        }
    })
    




    $.fn.fullpage.reBuild();

    $('#fullpage>section').css({
        'max-height': document.body.clientHeight
    })

    $("select").styler("destroy")
    initDropdown()


    
    $.ajax({
        type: 'post',
        url: '/ajax/dev.php',
        data: {
            "get_news": 1,
            "city_id":  city_idSecond,
        },
        success: function (data) {
            if(data != ''){
                $('.topNews').html('<i class="closeNews">X</i>'+data)
                $('.topNews').show()
            }
            else {
               $('.topNews').hide()
           }

       }
   })
}
}

$(document).on("change","#hotel_groups .group", function(){
    findRow();
});
$(document).on("change","#hotel_groups .departure", function(){
    findRow();
});
$(document).on("change","#hotel_groups .regions", function(){
    findRow();
});
$(document).on("change","#hotel_groups .hstars", function(){
    findRow();
});

function findRow(){
    $(".srows").each(function(){
        a=1;b=1;c=1;d=1;
        var gr = $(this).data('group');
        var cu = $(this).data('country');
        var re = $(this).data('regions');
        var st = $(this).data('stars');

        sgr = $("#hotel_groups select[name=group]").val();
        scu = $("#hotel_groups select[name=departure]").val();
        sre = $("#hotel_groups select[name=regions]").val();
        sst = $("#hotel_groups select[name=stars]").val();

        if(sgr!=0) if(gr==sgr) a=1; else a=0;
        if(scu!=0) if(cu==scu) b=1; else b=0;
        if(sre!=0) if(re==sre) c=1; else c=0;
        if(sst!=0) if(st==sst) d=1; else d=0;

        if(a&&b&&c&&d) $(this).show(); else $(this).hide();
    });


    $('.nav-item.cl').click(function(){
        $('.navigation').hide()
    }) 


}